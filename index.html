<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä»€åˆ¹æµ· Â· æ™ºèƒ½å¯¼è§ˆç³»ç»Ÿ</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-look-at-component@0.8.0/dist/aframe-look-at-component.min.js"></script>
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: '9c788ecfb3221cdc8390da98c8fc872f'
        };
    </script>
    <script src="https://webapi.amap.com/maps?v=2.0&key=8a7f84330ba776e17c18394547892d50"></script>
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft YaHei", sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        #vr-container {
            flex: 1.5;
            position: relative;
            background: #000;
            transition: flex 0.3s;
        }
        
        a-scene { width: 100%; height: 100%; }
        
        #vr-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; color: white; transition: opacity 0.5s;
        }
        #vr-overlay.hidden { opacity: 0; pointer-events: none; }
        
        .start-btn {
            padding: 15px 40px; border: 2px solid #4CC3D9; border-radius: 30px;
            background: transparent; color: white; font-size: 18px; cursor: pointer;
            transition: 0.3s; text-transform: uppercase; letter-spacing: 2px;
            margin-top: 20px;
        }
        .start-btn:hover { background: #4CC3D9; color: black; box-shadow: 0 0 15px #4CC3D9; }
        
        #sidebar {
            flex: 1;
            display: none; flex-direction: column;
            background: #f0f8ff; 
            border-left: 1px solid #ccc;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            position: relative; z-index: 50;
            border-radius: 10px 0 0 10px; 
        }
        
        .header-bar {
            padding: 15px 20px; background: #2c3e50; color: white;
            display: flex; justify-content: space-between; align-items: center;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }
        .header-bar h1 { margin: 0; font-size: 18px; }
        .header-bar h1::before { content: 'ğŸ§­ '; font-size: 20px; }
        
        .info-panel {
            padding: 20px;
            background: #ffffff;
            border-bottom: 1px solid #eee;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin: 10px;
        }
        .info-panel h2 { margin: 0 0 10px 0; font-size: 22px; color: #333; }
        .info-panel p { margin: 0 0 15px 0; color: #666; font-size: 14px; line-height: 1.6; }
        
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        
        .nav-btn, .audio-btn, .auto-tour-btn {
            border: none;
            padding: 8px 14px; border-radius: 20px;
            font-size: 13px; cursor: pointer;
            display: inline-flex; align-items: center; gap: 4px;
            transition: background 0.3s, transform 0.2s;
            color: white;
        }
        .nav-btn { background-color: #4285f4; }
        .nav-btn:hover { background-color: #3367d6; transform: scale(1.05); }
        
        .audio-btn { background-color: #ff9800; }
        .audio-btn:hover { background-color: #f57c00; transform: scale(1.05); }
        .audio-btn.playing { background-color: #e91e63; } 

        .auto-tour-btn { background-color: #4caf50; }
        .auto-tour-btn:hover { background-color: #43a047; transform: scale(1.05); }
        .auto-tour-btn.active { background-color: #2e7d32; box-shadow: 0 0 8px rgba(76, 175, 80, 0.6); animation: pulse 2s infinite; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }

        #amap-container {
            flex: 1; 
            width: 100%;
            background: #e6e6e6;
            position: relative;
            border-bottom-left-radius: 10px; 
            border-bottom-right-radius: 10px;
        }
        .custom-marker {
            background-color: white;
            border: 2px solid #333;
            border-radius: 50% 50% 50% 0;
            width: 24px; height: 24px;
            transform: rotate(-45deg);
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: 0.3s;
        }
        .custom-marker::after {
            content: ''; width: 14px; height: 14px; background: #666; border-radius: 50%;
        }
        .custom-marker:hover { transform: rotate(-45deg) scale(1.2); border-color: #4CC3D9; }
        .custom-marker.active { background-color: #FF4D4F; border-color: #FF4D4F; }
        .custom-marker.active::after { background: white; }
        
        .custom-info-window {
            pointer-events: none; 
            position: absolute;
            background: rgba(0,0,0,0.75);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            transform: translate(-50%, -100%);
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 9999;
        }
        .custom-info-window::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border: 6px solid transparent;
            border-top-color: rgba(0,0,0,0.75);
        }
        .custom-info-window img {
            width: 120px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            margin-top: 6px;
            display: block;
        }
        .custom-info-window.show { opacity: 1; }
        
        #fullscreen-btn {
            position: absolute; bottom: 10px; right: 10px; z-index: 10; display: none;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
        }
        #fullscreen-btn:hover { background: rgba(0,0,0,0.8); }

        .intro-image {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: -1; cursor: pointer;
            transition: box-shadow 0.3s, transform 0.3s;
        }
        .intro-image:hover {
            box-shadow: 0 0 20px rgba(76, 195, 217, 0.8);
            transform: scale(1.05);
        }

        /* ---------------------------------------------------- */
        /* ğŸ”¥ æ ¸å¿ƒé€‚é…ä»£ç ï¼šæ‰‹æœº/å¹³æ¿ç«¯æ ·å¼ (å±å¹•å®½åº¦å°äº768pxæ—¶ç”Ÿæ•ˆ) */
        /* ---------------------------------------------------- */
        @media screen and (max-width: 768px) {
            /* 1. æ”¹å˜æ•´ä½“å¸ƒå±€ä¸ºå‚ç›´æ’åˆ— (ä¸ŠVRï¼Œä¸‹åœ°å›¾) */
            body {
                flex-direction: column;
            }

            /* 2. VR å®¹å™¨å æ®ä¸ŠåŠéƒ¨åˆ† (60%é«˜åº¦) */
            #vr-container {
                flex: none; /* ç¦ç”¨flexè‡ªåŠ¨ç¼©æ”¾ */
                height: 60vh; 
                width: 100%;
            }

            /* 3. ä¾§è¾¹æ /åœ°å›¾å æ®ä¸‹åŠéƒ¨åˆ† (40%é«˜åº¦) */
            #sidebar {
                flex: none;
                height: 40vh;
                width: 100%;
                border-left: none; /* å»æ‰å·¦è¾¹æ¡† */
                border-top: 4px solid #2c3e50; /* é¡¶éƒ¨åŠ ä¸ªåˆ†å‰²çº¿ */
                border-radius: 0; /* å»æ‰åœ†è§’ï¼Œè´´åˆå±å¹• */
                margin: 0; /* é‡ç½®è¾¹è· */
            }
            
            /* 4. è°ƒæ•´ä¿¡æ¯é¢æ¿ï¼Œå‡å°‘æ‰‹æœºä¸Šçš„ç•™ç™½ */
            .info-panel {
                margin: 0;
                border-radius: 0;
                padding: 10px 15px;
                box-shadow: none;
                border-bottom: 1px solid #ddd;
            }

            /* 5. è°ƒæ•´æ ‡é¢˜å­—å· */
            .info-panel h2 {
                font-size: 18px;
                margin-bottom: 5px;
            }
            .info-panel p {
                font-size: 12px;
                margin-bottom: 10px;
                display: -webkit-box;
                -webkit-line-clamp: 2; /* é™åˆ¶æ–‡å­—è¡Œæ•°ï¼Œé˜²æ­¢å å¤ªå¤šåœ° */
                -webkit-box-orient: vertical;
                overflow: hidden;
            }

            /* 6. æŒ‰é’®æ é€‚é…ï¼šè®©æŒ‰é’®æ›´å¥½æŒ‰ */
            .btn-group {
                justify-content: space-between;
            }
            .nav-btn, .audio-btn, .auto-tour-btn {
                padding: 8px 10px;
                font-size: 12px;
                flex: 1; /* æŒ‰é’®å¹³åˆ†å®½åº¦ */
                justify-content: center;
            }

            /* 7. éšè—æ‰‹æœºä¸Šçš„å…¨å±æŒ‰é’® (å®¹æ˜“è¯¯è§¦ä¸”ä¸éœ€è¦) */
            #fullscreen-btn {
                display: none !important;
            }

            /* 8. è°ƒæ•´å¼€å§‹é¡µé¢çš„å¸ƒå±€ */
            #vr-overlay h2 {
                font-size: 20px;
                margin-bottom: 10px;
            }
            .start-btn {
                padding: 10px 30px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
<div id="vr-container">
    <div id="vr-overlay">
        <h2>ä»€åˆ¹æµ·å‰æµ· Â· æ²‰æµ¸å¼æ¸¸è§ˆ</h2>
        <img id="intro-image" class="intro-image" src="white.jpg" alt="æ¬¢è¿å›¾ç‰‡" onclick="startTour()">
        <button class="start-btn" id="start-btn">å¼€å¯æ¸¸è§ˆ</button>
    </div>
    <button id="fullscreen-btn">ğŸ” å…¨å±</button>
</div>
<div id="sidebar">
    <div class="header-bar">
        <h1>å¯¼è§ˆåœ°å›¾</h1>
    </div>
    <div class="info-panel">
        <h2 id="scene-title">å‡†å¤‡ä¸­...</h2>
        <p id="scene-desc">ç‚¹å‡»åœ°å›¾ä¸Šçš„æ ‡è®°ç‚¹å¼€å§‹æ¢ç´¢ã€‚</p>
        <div class="btn-group">
            <button class="auto-tour-btn" id="auto-tour-btn" onclick="toggleAutoTour()">â–¶ å¼€å¯è‡ªåŠ¨å¯¼è§ˆ</button>
            <button class="audio-btn" id="audio-control-btn" onclick="toggleSpeech()">ğŸ”Š å¬è®²è§£</button>
            <button class="nav-btn" onclick="openNavigation()">ğŸ“ å¯¼èˆªå‰å¾€</button>
        </div>
    </div>
    <div id="amap-container"></div>
</div>
<script>
// 1. å®šä¹‰æ¸¸è§ˆé¡ºåº
const tourSequence = [
    "scene_shicha", "scene_538", "scene_539", "scene_002", "scene_003", 
    "scene_004", "scene_005", "scene_007", "scene_008", "scene_011", 
    "scene_012", "scene_013", "scene_014", "scene_015"
];

const tourData = { 
    "scene_shicha": {
        title: "è·èŠ±å¸‚åœºå—é—¨",
        description: "å¤§å®¶è¯·çœ‹ï¼Œæˆ‘ä»¬ç°åœ¨æ‰€å¤„çš„ä½ç½®å°±æ˜¯è·èŠ±å¸‚åœºå—é—¨ã€‚å¤´é¡¶è¿™åº§å¤è‰²å¤é¦™çš„ç‰Œæ¥¼ï¼Œæ ‡å¿—ç€æˆ‘ä»¬æ­£å¼è¿›å…¥äº†å‰æµ·æ™¯åŒºã€‚å†å²ä¸Šï¼Œè¿™é‡Œæ˜¯æ¸…æœ«æ°‘åˆåŒ—äº¬æœ€çƒ­é—¹çš„æ¶ˆå¤åœºæ‰€ï¼Œå› æ¹–ä¸­è·èŠ±ç››å¼€è€Œå¾—åã€‚æ¯åˆ°å¤å¤©ï¼Œè¿™é‡Œæ­æ£šå”®è´§ï¼Œæ‚è€çŒ®è‰ºï¼Œæ˜¯è€åŒ—äº¬äººæœ€çˆ±çš„â€œå¤æ—¥æ¸¸ä¹åœºâ€ã€‚",
        videoSrc: "https://my-vr-tour-video.oss-cn-beijing.aliyuncs.com/shicha1.mp4",
        lnglat: [116.3909,39.93593],
        previewImg: "northgate.jpg",
        hotspots: [{ targetScene: "scene_538", position: "0 0 -10" }]
    },
    "scene_538": {
        title: "ç¯æ¹–ç»¿é“",
        description: "ç©¿è¿‡ç‰Œæ¥¼ï¼Œæˆ‘ä»¬æ¼«æ­¥åœ¨ç¯æ¹–ç»¿é“ä¸Šã€‚ä»€åˆ¹æµ·çš„æ ‡å¿—å°±æ˜¯è¿™äº›ä¾ä¾å‚æŸ³ï¼Œè€èˆå…ˆç”Ÿç¬”ä¸‹çš„åŒ—äº¬ä¹‹ç¾ï¼Œè¿™é‡Œå äº†ä¸€å¤§åŠã€‚å³æ‰‹è¾¹æ˜¯ç¢§æ³¢è¡æ¼¾çš„å‰æµ·ï¼Œå·¦æ‰‹è¾¹æ˜¯é’ç –ç°ç“¦çš„å»ºç­‘ã€‚å¤§å®¶å¯ä»¥æ·±å‘¼å¸ä¸€ä¸‹ï¼Œè¿™é‡Œçš„ç©ºæ°”ä¸­éƒ½é€ç€ä¸€è‚¡æ¸…å‡‰çš„æ°´æ±½ã€‚",
        videoSrc: "https://my-vr-tour-video.oss-cn-beijing.aliyuncs.com/test.mp4",
        lnglat: [116.391002,39.936523],
        previewImg: "green.jpg",
        hotspots: [{ targetScene: "scene_shicha", position: "0 0 10" }, { targetScene: "scene_539", position: "10 0 0" }, { targetScene: "scene_001", position: "-10 0 0" }]
    },
    "scene_539": {
        title: "è¿‘ç‹åºœå»Šæ¡¥",
        description: "å‰æ–¹è¿™æ®µæ ˆé“å’Œè¿å»Šï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºè¿‘ç‹åºœå»Šæ¡¥ã€‚ä¸ºä»€ä¹ˆå«â€œè¿‘ç‹åºœâ€å‘¢ï¼Ÿå› ä¸ºè¿™é™„è¿‘åè½ç€è‘—åçš„æ­ç‹åºœã€‚ç«™åœ¨å»Šæ¡¥ä¹‹ä¸Šï¼Œå»ºç­‘é£æ ¼æ˜æ˜¾å¸¦æœ‰çš‡å®¶å›­æ—çš„ç²¾è‡´ä¸æ°”æ´¾ã€‚è¿™é‡Œæ˜¯æ‹ç…§çš„ç»ä½³ç‚¹ä½ï¼ŒèƒŒæ™¯æ˜¯å¼€é˜”çš„æ¹–é¢å’Œè¿œå¤„çš„é’Ÿé¼“æ¥¼ï¼Œéå¸¸å‡ºç‰‡ã€‚",
        videoSrc: "https://my-vr-tour-video.oss-cn-beijing.aliyuncs.com/5.mp4",
        lnglat: [116.391988,39.936933],
        previewImg: "wfbri.jpg",
        hotspots: [{ targetScene: "scene_538", position: "-10 0 0" }, { targetScene: "scene_015", position: "0 0 -10" }]
    },
    "scene_002": {
        title: "ç‹åºœçš„ç¤¼ç‰©",
        description: "å¦‚æœå¤§å®¶æƒ³å¸¦ç‚¹æœ‰â€œçš‡æ°”â€çš„çºªå¿µå“ï¼Œè¿™å®¶â€œç‹åºœçš„ç¤¼ç‰©â€ä¸å®¹é”™è¿‡ã€‚è¿™é‡Œé›†åˆäº†è®¸å¤šå¯Œæœ‰åŒ—äº¬ç‰¹è‰²çš„æ–‡åˆ›äº§å“ï¼Œä»ç²¾è‡´çš„å¾¡æ‰‡åˆ°å‘†èŒçš„çŸ³ç‹®å­æ‘†ä»¶ï¼Œå°†ä¼ ç»Ÿçš„ç‹åºœæ–‡åŒ–å˜å¾—å¹´è½»æœ‰è¶£ã€‚å¤§å®¶å¯ä»¥è¿›å»é€›é€›ï¼Œç›–ä¸ªç« ï¼Œç•™ä¸ªçºªå¿µã€‚",
        videoSrc: "https://my-vr-tour-video.oss-cn-beijing.aliyuncs.com/6.mp4",
        lnglat: [116.393583,39.937504],
        previewImg: "wf.jpg",
        hotspots: [{ targetScene: "scene_538", position: "0 0 10" }, { targetScene: "scene_003", position: "0 0 -10" }]
    },
    "scene_003": {
        title: "å‰æµ·å°åƒè¡—",
        description: "é—»åˆ°é¦™å‘³äº†å—ï¼Ÿæˆ‘ä»¬æ¥åˆ°äº†å‰æµ·å°åƒè¡—ã€‚è¿™é‡Œæ±‡èšäº†å†°ç³–è‘«èŠ¦ã€çˆ†è‚šã€ç‚¸é…±é¢ç­‰å„ç§è€åŒ—äº¬ç‰¹è‰²ã€‚è™½ç„¶ç°åœ¨ä¸ºäº†ç¯ä¿æ•´æ²»äº†æ²¹çƒŸï¼Œä½†é‚£ç§çƒ­é—¹çš„å¸‚äº•çƒŸç«æ°”ä¾ç„¶æµ“éƒã€‚æ‰‹é‡Œæ‹¿ä¸²ç³–è‘«èŠ¦ï¼Œè¾¹èµ°è¾¹åƒï¼Œè¿™æ‰æ˜¯é€›ä»€åˆ¹æµ·çš„æ­£ç¡®å§¿åŠ¿ã€‚",
        videoSrc: "https://my-vr-tour-video.oss-cn-beijing.aliyuncs.com/7.mp4",
        lnglat: [116.393897,39.938047],
        previewImg: "xcj.jpg",
        hotspots: [{ targetScene: "scene_002", position: "0 0 10" }, { targetScene: "scene_004", position: "0 0 -10" }]
    },
    "scene_004": {
        title: "å‰æµ·é…’å§è¡—",
        description: "æ²¿ç€æ¹–è¾¹ç»§ç»­èµ°ï¼Œè¿™ä¸€æ’é£æ ¼å„å¼‚çš„å»ºç­‘å°±æ˜¯è‘—åçš„å‰æµ·é…’å§è¡—ã€‚ç™½å¤©è¿™é‡Œç›¸å¯¹å®‰é™ï¼Œå……æ»¡äº†æ–‡è‰ºæ°”æ¯ï¼›è€Œåˆ°äº†å¤œæ™šï¼Œéœ“è™¹é—ªçƒï¼Œæ­Œå£°æ‚ æ‰¬ï¼Œè¿™é‡Œæ˜¯åŒ—äº¬å¤œç”Ÿæ´»çš„åœ°æ ‡ï¼Œä¹Ÿæ˜¯è®¸å¤šæ°‘è°£æ­Œæ‰‹çš„æ‘‡ç¯®ã€‚å¤å…¸çš„ä»€åˆ¹æµ·åœ¨è¿™é‡Œä¸ç°ä»£æ—¶å°šå®Œç¾èåˆã€‚",
        videoSrc: "https://my-vr-tour-video.oss-cn-beijing.aliyuncs.com/8.mp4",
        lnglat: [116.393751,39.938504],
        previewImg: "bar.jpg",
        hotspots: [{ targetScene: "scene_003", position: "0 0 10" }, { targetScene: "scene_005", position: "0 0 -10" }]
    },
    "scene_005": {
        title: "é“¶é”­æ¡¥",
        description: "å„ä½ï¼Œæˆ‘ä»¬ç°åœ¨æ­£ç«™åœ¨æ•´ä¸ªä»€åˆ¹æµ·æœ€è‘—åçš„é“¶é”­æ¡¥ä¸Šã€‚è¿™åº§å½¢ä¼¼å…ƒå®çš„çŸ³æ¡¥ï¼Œæ˜¯å‰æµ·å’Œåæµ·çš„åˆ†ç•Œçº¿ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªè‘—åçš„æ™¯è§‚å«â€œé“¶é”­è§‚å±±â€â€”â€”åœ¨è¿‡å»æ²¡æœ‰é«˜æ¥¼é®æŒ¡ä¸”å¤©æ°”æ™´æœ—æ—¶ï¼Œå‘è¥¿çœºæœ›ï¼Œå¯ä»¥æ¸…æ™°åœ°çœ‹åˆ°è¥¿å±±ã€‚è¿™é‡Œä¹Ÿæ˜¯è¿æ¥çš‡åŸä¸å¸‚äº•çš„å’½å–‰è¦é“ã€‚",
        videoSrc: "https://my-vr-tour-video.oss-cn-beijing.aliyuncs.com/10.mp4",
        lnglat: [116.393414,39.938948],
        previewImg: "ydbri.jpg",
        hotspots: [{ targetScene: "scene_004", position: "0 0 10" }, { targetScene: "scene_006", position: "0 0 -10" }]
    },
    "scene_007": {
        title: "é¥­åº„ä¼‘æ¯åŒº",
        description: "è¿‡äº†æ¡¥ï¼Œè¿™ä¸€å¸¦æ˜¯é¥­åº„ä¼‘æ¯åŒºã€‚è¿™é‡Œèšé›†äº†å¦‚â€œåº†äº‘æ¥¼â€ç­‰ç™¾å¹´è€å­—å·ã€‚å¤§å®¶èµ°ç´¯äº†ï¼Œå¯ä»¥åœ¨è¿™é‡Œç¨ä½œä¼‘æ¯ã€‚ååœ¨ä¸´çª—çš„ä½ç½®ï¼Œä¸€è¾¹å“å°äº¬å‘³ç¾é£Ÿï¼Œä¸€è¾¹æ¬£èµçª—å¤–çš„æ¸¸èˆ¹å’Œæµæ°´ï¼Œåˆ«æœ‰ä¸€ç•ªé£å‘³ã€‚",
        videoSrc: "https://my-vr-tour-video.oss-cn-beijing.aliyuncs.com/13.mp4",
        lnglat: [116.393767,39.938994444],
        previewImg: "hotel.jpg",
        hotspots: [{ targetScene: "scene_005", position: "0 0 10" }, { targetScene: "scene_008", position: "0 0 -10" }]
    },
    "scene_008": {
        title: "åœ°ç™¾æ¸¸èˆ¹ç å¤´",
        description: "å‰æ–¹è¿™ä¸ªç å¤´æ˜¯åœ°ç™¾æ¸¸èˆ¹ç å¤´ï¼Œç´§é‚»åœ°å®‰é—¨ç™¾è´§å•†åœºã€‚ä»€åˆ¹æµ·æ›¾æ˜¯å…ƒä»£å¤§è¿æ²³æ¼•è¿çš„ç»ˆç‚¹ç å¤´ï¼Œè™½ç„¶ç°åœ¨æ²¡æœ‰äº†è¿ç²®èˆ¹ï¼Œä½†ä¿ç•™äº†æ¸¸èˆ¹æ–‡åŒ–ã€‚ä»è¿™é‡Œç™»èˆ¹ï¼Œæ¢ä¸ªè§’åº¦çœ‹ä¸¤å²¸å‚æŸ³æ‹‚é¢ï¼Œä¼šæ›´èƒ½ä½“ä¼šåˆ°â€œèˆ¹åœ¨æ°´ä¸­èµ°ï¼Œäººåœ¨ç”»ä¸­æ¸¸â€çš„æ„å¢ƒã€‚",
        videoSrc: "https://my-vr-tour-video.oss-cn-beijing.aliyuncs.com/14.mp4",
        lnglat: [116.394819,39.938144],
        previewImg: "mt.jpg",
        hotspots: [{ targetScene: "scene_007", position: "0 0 10" }, { targetScene: "scene_011", position: "0 0 -10" }]
    },
    "scene_011": {
        title: "æ­¥è¡Œè¡—",
        description: "æˆ‘ä»¬ç°åœ¨è½¬å…¥è¿æ¥æ™¯åŒºçš„æ­¥è¡Œè¡—ã€‚è¿™é‡Œäººå±±äººæµ·ï¼Œæ˜¯åŒ—äº¬ä¸­è½´çº¿æ—çš„é‡è¦å•†ä¸šè¡—åŒºã€‚ä¸¤ä¾§åº—é“ºæ—ç«‹ï¼Œæ—¢æœ‰æ—¶å°šæ½®ç‰Œï¼Œä¹Ÿæœ‰ä¼ ç»Ÿä¸ç»¸ã€å¸ƒé‹åº—ï¼Œå±•ç°äº†åŒ—äº¬ä½œä¸ºå›½é™…å¤§éƒ½å¸‚çš„ç¹åä¸€é¢ã€‚",
        videoSrc: "https://my-vr-tour-video.oss-cn-beijing.aliyuncs.com/15.mp4",
        lnglat: [116.395158,39.936207],
        previewImg: "street.jpg",
        hotspots: [{ targetScene: "scene_08", position: "0 0 10" }, { targetScene: "scene_012", position: "0 0 -10" }]
    },
    "scene_012": {
        title: "æ­¥è¡Œè¡—æ·±å¤„",
        description: "è®©æˆ‘ä»¬å¾€æ­¥è¡Œè¡—æ·±å¤„èµ°ä¸€èµ°ã€‚é¿å¼€ä¸»è·¯çš„å–§åš£ï¼Œè¿™é‡Œæ›´è´´è¿‘è€ç™¾å§“çš„ç”Ÿæ´»ã€‚å¶å°”èƒ½çœ‹åˆ°è€åŒ—äº¬çš„å››åˆé™¢é—¨æ¥¼ï¼Œå¬åˆ°å¤§çˆ·å¤§å¦ˆçš„é—²èŠå£°ã€‚è¿™é‡Œè—ç€åŒ—äº¬åŸçš„â€œé‡Œå­â€ï¼Œå®‰é™è€Œç¥¥å’Œã€‚",
        videoSrc: "https://my-vr-tour-video.oss-cn-beijing.aliyuncs.com/16.mp4",
        lnglat: [116.39365,39.935481],
        previewImg: "last.jpg",
        hotspots: [{ targetScene: "scene_011", position: "0 0 10" }, { targetScene: "scene_013", position: "0 0 -10" }]
    },
    "scene_013": {
        title: "å¹³å®‰ç å¤´",
        description: "ç»•å›åˆ°æ¹–è¾¹ï¼Œæˆ‘ä»¬æ¥åˆ°äº†å¹³å®‰ç å¤´ã€‚â€œå¹³å®‰â€äºŒå­—ï¼Œå¯„æ‰˜äº†äººä»¬ç¾å¥½çš„ç¥æ„¿ã€‚è¿™é‡Œçš„è§†é‡éå¸¸å¼€é˜”ï¼Œä¹Ÿæ˜¯è§‚èµå‰æµ·å…¨æ™¯çš„å¥½åœ°æ–¹ã€‚å¤§å®¶å¯ä»¥åœ¨è¿™é‡Œåˆå½±ç•™å¿µï¼ŒæŠŠâ€œå¹³å®‰â€å¸¦å›å®¶ã€‚",
        videoSrc: "https://my-vr-tour-video.oss-cn-beijing.aliyuncs.com/17.mp4",
        lnglat: [116.392756,39.934314],
        previewImg: "ddmatou.jpg",
        hotspots: [{ targetScene: "scene_012", position: "0 0 10" }, { targetScene: "scene_014", position: "0 0 -10" }]
    },
    "scene_014": {
        title: "å‰æµ·æ‹±æ¡¥",
        description: "å‰æ–¹è¿™åº§ä¼˜ç¾çš„å‰æµ·æ‹±æ¡¥ï¼Œå¦‚åŒä¸€é“é•¿è™¹å§æ³¢ã€‚å®ƒçš„çŸ³æ‹±æ›²çº¿ä¸æ°´ä¸­çš„å€’å½±ç›¸æ˜ æˆè¶£ï¼Œå½¢æˆäº†ä¸€ä¸ªå®Œç¾çš„åœ†å½¢ã€‚æ— è®ºæ˜¯åœ¨æ¡¥ä¸Šèµ°ï¼Œè¿˜æ˜¯åœ¨è¿œå¤„çœ‹ï¼Œå®ƒéƒ½æ˜¯å‰æµ·ç”»å·ä¸­ç‚¹ç›çš„ä¸€ç¬”ã€‚",
        videoSrc: "https://my-vr-tour-video.oss-cn-beijing.aliyuncs.com/18.mp4",
        lnglat: [116.392244,39.933643],
        previewImg: "bri.jpg",
        hotspots: [{ targetScene: "scene_013", position: "0 0 10" }, { targetScene: "scene_015", position: "0 0 -10" }]
    },
    "scene_015": {
        title: "è·èŠ±å¸‚åœºä¸€æ¡è¡—",
        description: "æœ€åï¼Œæˆ‘ä»¬å›åˆ°äº†è·èŠ±å¸‚åœºä¸€æ¡è¡—çš„ä¸»è¡—ã€‚è¿™æ¡è¡—ä½äºä»€åˆ¹æµ·å‰æµ·çš„è¥¿å²¸ï¼Œå…¨é•¿çº¦280ç±³ï¼Œæ˜¯è€åŒ—äº¬æ¶ˆå¤èƒœåœ°çš„ä»£è¡¨ã€‚ä»€åˆ¹æµ·ï¼Œåˆç§°åæµ·ï¼ŒåŒ…æ‹¬å‰æµ·ã€åæµ·å’Œè¥¿æµ·ï¼Œæ˜¯å…ƒä»£å¤§è¿æ²³çš„èµ·ç‚¹ï¼Œæ°´åŸŸå®½é˜”ï¼Œæ¹–å…‰å±±è‰²å®œäººã€‚è·èŠ±å¸‚åœºå…´èµ·äº20ä¸–çºª20å¹´ä»£ï¼Œé‚£æ—¶è¿™é‡Œæ˜¯å”®å–é²œè·ã€å†°ç¢—ç­‰é£Ÿå“çš„æ‘Šç‚¹ï¼Œè¿˜æœ‰å„ç§æ¸¸è‰ºåœºæ‰€ï¼Œæˆä¸ºå¹³æ°‘ç™¾å§“é¿æš‘çš„å¥½å»å¤„ã€‚è®©æˆ‘ä»¬ä»å†å²è¯´èµ·ã€‚æ—©åœ¨æ™šæ¸…æ—¶æœŸï¼Œä»€åˆ¹æµ·å°±è¢«ç§°ä¸ºâ€œæ²³æ²¿â€ï¼Œæ¯åˆ°å¤å­£ï¼Œè·èŠ±ç››å¼€ï¼Œæ–‡äººé›…å£«å’Œä»•å¥³ä»¬çº·è‡³æ²“æ¥ã€‚1906å¹´çš„ã€Šç‡•äº¬å²æ—¶è®°ã€‹è®°è½½ï¼Œè¿™é‡Œè·èŠ±èŒ‚ç››ï¼Œå¸å¼•æ— æ•°æ¸¸å®¢ã€‚åˆ°äº†æ°‘å›½å¹´é—´ï¼Œå¸‚åœºè¾¾åˆ°é¼ç››ï¼Œä¸­å¤®å ¤åä¸Šæ‘Šä½æ—ç«‹ï¼Œå—åŠéƒ¨æ˜¯é£Ÿå“æ‘Šï¼ŒåŒ—åŠéƒ¨æ˜¯èŒ¶é¦†å’Œæ‚è€è¡¨æ¼”ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¤å¤œé‡Œï¼ŒæŸ³æ ‘å©†å¨‘ï¼Œè·é¦™æ‰‘é¼»ï¼Œæ¸¸å®¢ä»¬å“å°ç€å‡‰ç²‰ã€é…¸æ¢…æ±¤ã€æ–°é²œè²è—•ã€æ°´è±è§’å’Œè±è§’ï¼Œè¾¹åƒè¾¹å¬æˆæ›²ã€çœ‹æ­¦æœ¯ï¼Œçƒ­é—¹éå‡¡ã€‚ä¸œå²¸çš„å°è¡—å¤´å…¬å›­æ›¾æ˜¯é©¬æˆå’Œæ­¦æœ¯çš„åœºåœ°ï¼ŒåŒ—å²¸æœ‰æ­Œå‰§å’Œå°åƒæ‘Šï¼Œç”šè‡³æœ‰æé¢äººã€ç¼–è‰è‰ºçš„åŒ äººã€‚è‘—åçš„ä¼šä»™å ‚é¤å…ï¼Œå°±åœ¨è¿™é‡Œä¾›åº”å±±ä¸œèœï¼Œå¦‚è·å¶ç²¥ã€è²å­é…¿é¸­ç­‰ï¼Œç”¨æ¹–ä¸­é²œè´§çƒ¹é¥ªï¼Œå¸å¼•äº†æ¢…å…°èŠ³ç­‰åè§’å‰æ¥ã€‚ è€èˆå…ˆç”Ÿåœ¨ä½œå“ä¸­ä¹Ÿæç»˜è¿‡è¿™é‡Œï¼šååœ¨æŸ³è«ä¸‹å–èŒ¶ï¼Œåƒé…¸æ¢…ç³•ï¼Œæˆ–å“å…«å®è²å¶ç²¥ï¼Œé’“é±¼ã€æ¸¸æ³³ï¼Œå…¶ä¹èèã€‚å¦‚ä»Šï¼Œç»è¿‡2017å¹´çš„è°ƒæ•´å’Œå‡çº§ï¼Œè·èŠ±å¸‚åœºé‡è·æ–°ç”Ÿã€‚é…’å§è¡—è½¬å‹ä¸ºå®é™æ–‡è‰ºçš„æ­¥è¡Œè¡—ï¼Œå»ºç­‘é£æ ¼å¤šæ ·ï¼Œæœ‰çš„ä»¿å¤é›•æ¢ç”»æ ‹ï¼Œæœ‰çš„ä¿ç•™è€åŒ—äº¬ç°ç –ç“¦ï¼Œåœ°é¢äº•ç›–ä¸Šåˆ»ç€ç²¾ç¾çš„è²èŠ±å›¾æ¡ˆã€‚æ¼«æ­¥è¡—å¤´ï¼Œä½ ä¼šçœ‹åˆ°çº¢æ æ†ã€ç§‹è·æ®‹æ¢—ï¼Œå¶å°”æœ‰é‡é¸­å¬‰æ°´ã€‚å¤å­£è·èŠ±ç»½æ”¾ï¼Œå€’æ˜ æ¹–ä¸­ï¼Œè¿œå¤„é¼“æ¥¼å·å³¨ï¼Œå¤©æ°”å¥½æ—¶è¿˜èƒ½é¥æœ›è¥¿å±±ã€‚è¡—è¾¹åº—é“ºé—¨å¤´å¤æœ´ï¼Œå‡ºå”®æ–‡åˆ›ã€æ‰‹å·¥è‰ºå“å’Œå°åƒï¼Œä¸å†å–§é—¹ï¼Œè€Œæ˜¯å……æ»¡è¯—æ„ã€‚ä»€åˆ¹æµ·è·èŠ±å¸‚åœºä¸ä»…æ˜¯æ™¯ç‚¹ï¼Œæ›´æ˜¯è€åŒ—äº¬ç”Ÿæ´»çš„ç¼©å½±ã€‚å¤å…¸ä¸ç°ä»£ç›¸èï¼Œè‡ªç„¶ä¸äººæ–‡è¾‰æ˜ ã€‚å¸Œæœ›å¤§å®¶åœ¨è¿™é‡Œåº¦è¿‡æ„‰å¿«æ—¶å…‰ï¼Œå¯¼æ¸¸åˆ°æ­¤ç»“æŸï¼Œå¸Œæœ›å¤§å®¶ç©å¾—å¼€å¿ƒï¼",
        videoSrc: "https://my-vr-tour-video.oss-cn-beijing.aliyuncs.com/19.mp4",
        lnglat: [116.39127,39.93486],
        previewImg: "hh.jpg",
        hotspots: [{ targetScene: "scene_014", position: "0 0 10" }, { targetScene: "scene_539", position: "0 0 -10" }]
    }
};

let currentSceneId = "scene_shicha";
let map = null;
let markers = {};
let videoEl = null; 
let hotspotsContainer = null; 
let mainSphere = null; 
const overlayEl = document.querySelector('#vr-overlay');
const startBtn = document.querySelector('#start-btn');
const uiTitle = document.getElementById('scene-title');
const uiDesc = document.getElementById('scene-desc');
const audioBtn = document.getElementById('audio-control-btn');
const autoTourBtn = document.getElementById('auto-tour-btn');
const sidebar = document.getElementById('sidebar'); // ä¾§è¾¹æ 
const vrContainer = document.getElementById('vr-container'); // VRå®¹å™¨

// --- éŸ³é¢‘å˜é‡ ---
let synth = window.speechSynthesis;
let currentAudio = null; // æ§åˆ¶MP3
let currentUtterance = null; // æ§åˆ¶æœºå™¨éŸ³
let isSpeaking = false;
let isAutoTouring = false;
let autoTourTimer = null;
let selectedVoice = null; 

// --- åˆå§‹åŒ–ç³»ç»Ÿè¯­éŸ³åˆ—è¡¨ï¼ˆä½œä¸ºMP3å¤±è´¥çš„å¤‡é€‰ï¼‰ ---
function initVoices() {
    const voices = synth.getVoices();
    selectedVoice = voices.find(v => v.lang.includes('zh') && v.name.includes('Google')) ||
                    voices.find(v => v.lang.includes('zh') && v.name.includes('Microsoft')) ||
                    voices.find(v => v.lang.includes('zh'));
}
if (speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = initVoices;
}
initVoices();

startBtn.addEventListener('click', () => {
    overlayEl.classList.add('hidden');
    
    // åˆå§‹åŒ– A-Scene (æ€§èƒ½ä¼˜åŒ–æ ¸å¿ƒ)
    const sceneEl = document.createElement('a-scene');
    sceneEl.setAttribute('embedded', '');
    sceneEl.setAttribute('loading-screen', 'dotsColor: white; backgroundColor: black');
    sceneEl.setAttribute('xr-mode-ui', 'enabled: false'); 
    // ğŸ”¥ ä¼˜åŒ–1ï¼šå…³é—­æŠ—é”¯é½¿ï¼Œé™ä½ç²¾åº¦ï¼Œæå¤§æå‡æµç•…åº¦
    sceneEl.setAttribute('renderer', 'antialias: false; precision: mediump; sortObjects: false;');
    
    sceneEl.innerHTML = `
        <a-assets>
            <video id="my360video" src="" loop crossorigin="anonymous" playsinline webkit-playsinline></video>
            <a-mixin id="hotspot-mixin" geometry="primitive: circle; radius: 1" material="color: white; opacity: 0.3; shader: flat" animation__scale="property: scale; to: 1.2 1.2 1; dir: alternate; loop: true; dur: 1000"></a-mixin>
        </a-assets>
        <a-videosphere id="main-sphere" src="#my360video" rotation="0 -90 0" visible="false"></a-videosphere>
        <a-entity id="hotspots-container"></a-entity>
        <a-camera id="cam" look-controls="enabled: true">
            <a-cursor material="opacity: 0" geometry="primitive: ring; radiusInner:0; radiusOuter:0" raycaster="objects: .hotspot"></a-cursor>
        </a-camera>
    `;
    vrContainer.appendChild(sceneEl);

    // ğŸ”¥ ä¼˜åŒ–2ï¼šå¼ºåˆ¶é™åˆ¶åƒç´ æ¯”ï¼Œé˜²æ­¢4Kå±å¡æ­»
    sceneEl.addEventListener('loaded', () => {
        const renderer = sceneEl.renderer;
        if (renderer) {
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
        }
    });
    
    videoEl = document.querySelector('#my360video');
    hotspotsContainer = document.querySelector('#hotspots-container');
    mainSphere = document.getElementById('main-sphere');
    
    initVR();
    
    setTimeout(() => {
        initMap();
    }, 100);
    document.getElementById('sidebar').style.display = 'flex';
    
    initFullscreenLogic();

    // é»˜è®¤å¼€å¯è‡ªåŠ¨å¯¼è§ˆæ¨¡å¼
    isAutoTouring = true;
    updateAutoTourBtnStyle();
    speakDescription(tourData[currentSceneId].description);
});

function startTour() {
    startBtn.click();
}

function initVR() {
    videoEl.muted = false; 
    loadScene(currentSceneId, true);
}

// --- å…¨å±é€»è¾‘ä¼˜åŒ– (è§£å†³å¡é¡¿) ---
function initFullscreenLogic() {
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    fullscreenBtn.style.display = 'block';
    
    fullscreenBtn.addEventListener('click', () => {
        if (!document.fullscreenElement) {
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            } else if (document.documentElement.webkitRequestFullscreen) {
                document.documentElement.webkitRequestFullscreen();
            }
        } else {
            if (document.exitFullscreen) document.exitFullscreen();
        }
    });

    document.addEventListener('fullscreenchange', handleFullscreenChange);
    document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
}

function handleFullscreenChange() {
    if (document.fullscreenElement || document.webkitFullscreenElement) {
        // ğŸ”¥ ä¼˜åŒ–3ï¼šå…¨å±æ—¶éšè—ä¾§è¾¹æ å’Œåœ°å›¾ï¼Œé‡Šæ”¾æ˜¾å¡èµ„æº
        sidebar.style.display = 'none'; 
        vrContainer.style.flex = '1'; 
        vrContainer.style.width = '100vw';
        vrContainer.style.height = '100vh';
        const scene = document.querySelector('a-scene');
        if(scene) scene.resize();
    } else {
        // æ¢å¤
        // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦æ ¹æ®å½“å‰å±å¹•å®½åº¦å†³å®šæ¢å¤æˆä»€ä¹ˆæ ·ï¼Œä½†CSSå·²ç»å¤„ç†äº†flexï¼Œè¿™é‡Œåªéœ€è¦æ¢å¤display
        sidebar.style.display = 'flex'; 
        // æ¢å¤flexå€¼ï¼Œè¿™é‡Œé‡ç½®ä¸ºç©ºï¼Œè®©CSSæ§åˆ¶
        vrContainer.style.flex = '';
        vrContainer.style.width = '';
        vrContainer.style.height = ''; 
        
        // å¼ºåˆ¶è§¦å‘ä¸€æ¬¡é‡ç»˜
        if(window.innerWidth > 768) {
            vrContainer.style.flex = '1.5';
        }
        
        const scene = document.querySelector('a-scene');
        if(scene) scene.resize();
        if (map) map.resize(); 
    }
}

// --- è¯­éŸ³æ’­æ”¾æ ¸å¿ƒ (MP3ä¼˜å…ˆ -> å¤±è´¥è½¬æœºå™¨éŸ³) ---
function speakDescription(text) {
    // åœæ­¢æ‰€æœ‰å£°éŸ³
    if (currentAudio) { currentAudio.pause(); currentAudio = null; }
    if (synth.speaking) { synth.cancel(); }

    if (!text) {
        resetAudioState();
        return;
    }

    // å°è¯•æ’­æ”¾MP3
    const audioPath = 'audio/' + currentSceneId + '.mp3';
    console.log("å°è¯•æ’­æ”¾:", audioPath);

    currentAudio = new Audio(audioPath);
    
    // ç›‘å¬æ’­æ”¾æˆåŠŸ
    currentAudio.onplay = () => {
        isSpeaking = true;
        updateAudioBtnStyle();
        if(videoEl) videoEl.muted = true;
    };

    // æ’­æ”¾ç»“æŸ
    currentAudio.onended = () => {
        resetAudioState();
        handleAutoTourJump();
    };

    // ğŸ”¥ å…³é”®ï¼šMP3åŠ è½½å¤±è´¥ï¼ˆå¦‚æœªä¸‹è½½ï¼‰ï¼Œè‡ªåŠ¨è½¬æœºå™¨éŸ³
    currentAudio.onerror = () => {
        console.warn("MP3æœªæ‰¾åˆ°ï¼Œé™çº§ä½¿ç”¨æœºå™¨è¯­éŸ³");
        currentAudio = null;
        fallbackToRobotVoice(text);
    };

    // å°è¯•æ’­æ”¾
    const playPromise = currentAudio.play();
    if (playPromise !== undefined) {
        playPromise.catch(e => {
            console.log("MP3æ’­æ”¾è¢«é˜»æ‹¦æˆ–å¤±è´¥ï¼Œå°è¯•æœºå™¨éŸ³");
            fallbackToRobotVoice(text);
        });
    }
}

// å…œåº•æœºå™¨éŸ³æ–¹æ¡ˆ
function fallbackToRobotVoice(text) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'zh-CN';
    utterance.rate = 1;
    if (selectedVoice) utterance.voice = selectedVoice;

    utterance.onstart = () => {
        isSpeaking = true;
        updateAudioBtnStyle();
        if(videoEl) videoEl.muted = true;
    };
    utterance.onend = () => {
        resetAudioState();
        handleAutoTourJump();
    };
    utterance.onerror = () => resetAudioState();
    
    currentUtterance = utterance;
    synth.speak(utterance);
}

function handleAutoTourJump() {
    if (isAutoTouring) {
        console.log("è¯­éŸ³ç»“æŸï¼Œå‡†å¤‡è·³è½¬...");
        autoTourTimer = setTimeout(() => {
            if(isAutoTouring) playNextSceneInSequence();
        }, 3000);
    }
}

function playNextSceneInSequence() {
    const currentIndex = tourSequence.indexOf(currentSceneId);
    if (currentIndex !== -1 && currentIndex < tourSequence.length - 1) {
        loadScene(tourSequence[currentIndex + 1], true); 
    } else {
        stopAutoTour();
        alert("ğŸ‰ å…¨ç¨‹å¯¼è§ˆç»“æŸï¼");
    }
}

function resetAudioState() {
    isSpeaking = false;
    updateAudioBtnStyle();
    if(videoEl) videoEl.muted = false;
}

// --- äº¤äº’æ§åˆ¶ ---
function toggleAutoTour() {
    if (isAutoTouring) {
        stopAutoTour();
    } else {
        isAutoTouring = true;
        if (!isSpeaking) speakDescription(tourData[currentSceneId].description);
    }
    updateAutoTourBtnStyle();
}

function stopAutoTour() {
    isAutoTouring = false;
    if (autoTourTimer) clearTimeout(autoTourTimer);
    updateAutoTourBtnStyle();
}

function updateAutoTourBtnStyle() {
    const btn = document.getElementById('auto-tour-btn');
    if (isAutoTouring) {
        btn.innerHTML = 'â¸ è‡ªåŠ¨å¯¼è§ˆä¸­...';
        btn.classList.add('active');
    } else {
        btn.innerHTML = 'â–¶ å¼€å¯è‡ªåŠ¨å¯¼è§ˆ';
        btn.classList.remove('active');
    }
}

function toggleSpeech() {
    if (isSpeaking) {
        if (currentAudio) { currentAudio.pause(); currentAudio = null; }
        if (synth.speaking) { synth.cancel(); }
        resetAudioState();
        stopAutoTour();
    } else {
        speakDescription(tourData[currentSceneId].description);
    }
}

function updateAudioBtnStyle() {
    const btn = document.getElementById('audio-control-btn');
    if (isSpeaking) {
        btn.innerHTML = 'â¹ åœæ­¢è®²è§£';
        btn.classList.add('playing');
    } else {
        btn.innerHTML = 'ğŸ”Š å¬è®²è§£';
        btn.classList.remove('playing');
    }
}

// --- åœºæ™¯åŠ è½½ä¸åœ°å›¾ ---
function loadScene(id, isSystemJump = false) {
    if (!isSystemJump) stopAutoTour();

    const data = tourData[id];
    if (mainSphere) mainSphere.setAttribute('visible', false);
    
    videoEl.pause();
    videoEl.src = data.videoSrc;
    // ğŸ”¥ ä¼˜åŒ–4ï¼šç§»é™¤å¼ºåˆ¶ä¿®æ”¹videoå®½é«˜çš„ä»£ç ï¼Œé¿å…å†…å­˜æ³¢åŠ¨
    
    videoEl.load();
    videoEl.onloadeddata = () => {
        if (mainSphere) mainSphere.setAttribute('visible', true);
        if (overlayEl.classList.contains('hidden')) {
            videoEl.play().catch(e => console.error("Video Autoplay Blocked", e));
        }
    };
    
    uiTitle.innerText = data.title;
    uiDesc.innerText = data.description;
    
    if (overlayEl.classList.contains('hidden')) {
        speakDescription(data.description);
    }

    renderVRHotspots(data.hotspots);
    updateMapHighlight(id);
    if (map) map.panTo(data.lnglat);
    currentSceneId = id;
}

// --- åœ°å›¾éƒ¨åˆ†ä¿æŒä¸å˜ ---
function createInfoWindow() {
    const div = document.createElement('div');
    div.className = 'custom-info-window';
    div.innerHTML = `<div class="title"></div><img src="" alt="é¢„è§ˆå›¾">`;
    document.body.appendChild(div);
    return div;
}
const infoWindow = createInfoWindow();
let containerRect = null;

function initMap() {
    if (typeof AMap === 'undefined') return;
    map = new AMap.Map('amap-container', {
        zoom: 16,
        center: tourData[currentSceneId].lnglat,
        viewMode: '3D',
        mapStyle: 'amap://styles/whitesmoke'
    });
    
    map.on('complete', function(){
        map.setFitView();
        map.setCenter(tourData[currentSceneId].lnglat);
        containerRect = document.getElementById('amap-container').getBoundingClientRect();
    });

    for (let key in tourData) {
        const scene = tourData[key];
        const markerDom = document.createElement('div');
        markerDom.className = 'custom-marker';
        markerDom.addEventListener('mouseenter', () => markerDom.style.transform = 'rotate(-45deg) scale(1.4)');
        markerDom.addEventListener('mouseleave', () => markerDom.style.transform = 'rotate(-45deg) scale(1)');
        
        const marker = new AMap.Marker({
            position: scene.lnglat,
            content: markerDom,
            offset: new AMap.Pixel(-12, -24),
            map: map
        });
        
        marker.on('mouseover', (e) => {
            if (!containerRect) return;
            infoWindow.querySelector('.title').textContent = scene.title;
            infoWindow.querySelector('img').src = scene.previewImg || 'images/default.jpg';
            infoWindow.classList.add('show');
            const absX = e.pixel.x + containerRect.left;
            const absY = e.pixel.y + containerRect.top;
            infoWindow.style.left = absX + 'px';
            infoWindow.style.top = absY + 'px';
            
            const moveHandler = (ev) => {
                const moveAbsX = ev.pixel.x + containerRect.left;
                const moveAbsY = ev.pixel.y + containerRect.top;
                infoWindow.style.left = moveAbsX + 'px';
                infoWindow.style.top = moveAbsY + 'px';
            };
            map.on('mousemove', moveHandler);
            marker._moveHandler = moveHandler;
        });
        
        marker.on('mouseout', () => {
            infoWindow.classList.remove('show');
            if (marker._moveHandler) {
                map.off('mousemove', marker._moveHandler);
                delete marker._moveHandler;
            }
        });
        
        marker.on('click', () => {
            stopAutoTour();
            loadScene(key);
        });
        markers[key] = { marker, dom: markerDom };
    }
    updateMapHighlight(currentSceneId);
}

function updateMapHighlight(id) {
    for (let key in markers) {
        if (markers[key] && markers[key].dom) {
            markers[key].dom.classList.remove('active');
        }
    }
    if (markers[id] && markers[id].dom) {
        markers[id].dom.classList.add('active');
    }
}

function renderVRHotspots(list) {
    hotspotsContainer.innerHTML = '';
    list.forEach(spot => {
        const el = document.createElement('a-entity');
        el.setAttribute('mixin', 'hotspot-mixin');
        el.setAttribute('class', 'hotspot');
        el.setAttribute('position', spot.position);
        el.setAttribute('look-at', '#cam');
        el.addEventListener('click', () => {
            stopAutoTour();
            loadScene(spot.targetScene);
        });
        hotspotsContainer.appendChild(el);
    });
}

function openNavigation() {
    const data = tourData[currentSceneId];
    const [lng, lat] = data.lnglat;
    const url = `https://uri.amap.com/marker?position=${lng},${lat}&name=${encodeURIComponent(data.title)}`;
    window.open(url, '_blank');
}

document.addEventListener('DOMContentLoaded', () => {
    uiTitle.innerText = tourData[currentSceneId].title;
    uiDesc.innerText = tourData[currentSceneId].description;
});
</script>
</body>
</html>